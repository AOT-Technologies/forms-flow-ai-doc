<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Forms flow ai documentation">
  <meta name="author" content="formsflow.ai">
  <link rel="shortcut icon" href="favicon.ico">
  <title>Welcome to formsflow.ai</title>

  <!-- Google Font -->
  <!-- <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700&display=swap" rel="stylesheet"> -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">

  <!-- FontAwesome JS-->
  <script defer src="assets/fontawesome/js/all.min.js"></script>

  <!-- Plugins CSS -->
  <link rel="stylesheet" href="assets/plugins/simplelightbox/simple-lightbox.min.css">

  <!-- Theme CSS -->
  <link id="theme-style" rel="stylesheet" href="assets/css/theme.css">
  <link id="theme-style" rel="stylesheet" href="assets/css/atom-one-dark.min.css">



</head>

<body>

  <header class="header fixed-top">
    <div class="branding docs-branding">
      <div class="container-fluid position-relative py-2">
        <div class="docs-logo-wrapper">
          <button id="docs-sidebar-toggler" class="docs-sidebar-toggler docs-sidebar-visible me-2 d-xl-none"
            type="button">
            <span></span>
            <span></span>
            <span></span>
          </button>
          <div class="site-logo"><a class="navbar-brand" href="index.html"><img class="logo-icon me-2"
                src="assets/images/formsflow.ai-logo.svg" alt="logo"><span class="logo-text">formsflow.ai</span></a>
          </div>
        </div>
        <!--//docs-logo-wrapper-->
        <div class="docs-top-utilities d-flex justify-content-end align-items-center">
          <div class="top-search-box d-none d-lg-flex">
            <form class="search-form">
              <input type="text" placeholder="Search the docs..." name="search" class="form-control search-input">
              <button type="submit" class="btn search-btn" value="Search"><i class="fas fa-search"></i></button>
            </form>
          </div>

          <ul class="social-list list-inline mx-md-3 mx-lg-5 mb-0 d-none d-lg-flex">
            <li class="list-inline-item"><a href="https://github.com/AOT-Technologies/forms-flow-ai"><i
                  class="fab fa-github fa-fw"></i></a></li>
          </ul>
          <!--//social-list-->
          <a href="https://github.com/AOT-Technologies/forms-flow-ai"
            class="btn btn-primary d-none d-lg-flex">Download</a>
        </div>
        <!--//docs-top-utilities-->
      </div>
      <!--//container-->
    </div>
    <!--//branding-->
  </header>
  <!--//header-->

  <div class="docs-wrapper">
    <div id="docs-sidebar" class="docs-sidebar">
      <div class="top-search-box d-lg-none p-3">
        <form class="search-form">
          <input type="text" placeholder="Search the docs..." name="search" class="form-control search-input">
          <button type="submit" class="btn search-btn" value="Search"><i class="fas fa-search"></i></button>
        </form>
      </div>
      <nav id="docs-nav" class="docs-nav navbar">
        <ul class="section-items list-unstyled nav flex-column pb-3">
          <!-- main heading -->
          <li class="nav-item section-title"><a class="nav-link scrollto active" href="#section-1"><span
                class="theme-icon-holder me-2"><i class="fas fa-map-signs"></i></span>Getting
              started</a></li>
          <li class="nav-item"><a href="index.html" style="color:  #566573">Introduction</a></li>
          <li class="nav-item"><a href="architecture.html" style="color:  #566573">System Architecture</a>
          </li>
          <li class="nav-item"><a href="aboutproject.html" style="color:  #566573">About The Project</a>
					</li>
					<li class="nav-item"><a href="UsageInstructions.html" style="color:  #566573">Usage-instructions</a>
					</li>
					<!-- main heading -->
					<li class="nav-item section-title mt-3"><a class="nav-link scrollto" href="#section-2"><span
								class="theme-icon-holder me-2"><i class="fas fa-arrow-down"></i></span>Installation</a>
					</li>
					<li class="nav-item"><a href="quick installation.html" style="color:  #566573">Quick
							Installation</a></li>

					<details>
								<summary><a href="download and installation.html" style="color:  #566573">Install Using Containers</a></summary>
								<ul>
								  <li class="nav-item"><a href="keycloak setup.html" style="color:  #566573">Keycloak</a></li>
								  <li class="nav-item"><a href="Form Management Platform.html" style="color:  #566573">Form Management Platform</a></li>
								  <li class="nav-item"><a href="Analytics Engine.html" style="color:  #566573">Analytics Engine</a></li>
								  <li class="nav-item"><a href="formsflow.ai Web Application.html" style="color:  #566573">Formsflow.ai Web Application</a></li>
								  <li class="nav-item"><a href="formsflow.ai API.html" style="color:  #566573">Formsflow.ai API</a></li>
								  <li class="nav-item"><a href="Workflow Engine.html" style="color:  #566573">Workflow Engine</a></li>
								</ul>
							  </details>
					
					<li class="nav-item"><a href="Openshift.html" style="color:  #566573">Openshift
							Installation</a></li>
					<li class="nav-item section-title mt-3"><a class="nav-link scrollto" href="#section-3"><span
								class="theme-icon-holder me-2"><i class="fas fa-arrow-down"></i></span>Features</a></li>
							
					
					<li class="nav-item"><a href="Internationalization.html"
							style="color:  #566573">Internationalization</a></li>
					<li class="nav-item"><a href="Listeners.html" style="color:  #566573">Camunda Listeners</a></li>
					
					<li class="nav-item"><a href="Taskvariables.html" style="color:  #566573">Task
							variable workflow</a></li>
					<li class="nav-item"><a href="Webevents.html" style="color:  #566573">Web Events</a></li>
					<li class="nav-item"><a href="AnonymousForm.html" style="color:  #566573">Anonymous Forms</a></li>
					<li class="nav-item"><a href="AdminPageDashboard.html" style="color:  #566573">AdminPage
						Dashboard</a></li>
					<li class="nav-item section-title mt-3"><a class="nav-link scrollto" href="#section-4"><span
						class="theme-icon-holder me-2"><i class="fas fa-arrow-down"></i></span>Multi Tenancy</a></li>
						<li class="nav-item"><a href="Tenant-based task assignment.html"
							style="color:  #566573">Tenant-based task assignment</a></li>
			
          <!-- main heading -->
          <li class="nav-item section-title mt-3"><a class="nav-link scrollto" href="#section-9"><span
                class="theme-icon-holder me-2"><i class="fas fa-lightbulb"></i></span>FAQs</a></li>
          <li class="nav-item"><a class="nav-link scrollto" href="#item-9-1">Section Item 9.1</a></li>
          <li class="nav-item"><a class="nav-link scrollto" href="#item-9-2">Section Item 9.2</a></li>
          <li class="nav-item"><a class="nav-link scrollto" href="#item-9-3">Section Item 9.3</a></li>
        </ul>

      </nav>
      <!--//docs-nav-->
    </div>
    <!--//docs-sidebar-->
    <div class="docs-content">
      <div class="container">
        <article class="docs-article" id="section-1">
          <!-- main heading content -->
          <header class="docs-header">



            <br>

            <section class="docs-section" id="item-1-1">
              <div>
                <h2 id="patroni-build">patroni-build.yaml</h2>
                <pre><code>
apiVersion: v1
kind: Template
metadata:
  creationTimestamp: null
  name: patroni
labels:
  app: ${NAME}${SUFFIX}
  phase: build
  app.kubernetes.io/component: database
  app.kubernetes.io/name: patroni
  app.kubernetes.io/managed-by: template
  app.kubernetes.io/version: "${PG_VERSION}"
parameters:
  - name: NAME
    value: patroni
  - name: SUFFIX
  - name: OUT_VERSION
    description: Ouput version
    value: "v10-latest"
  - name: GIT_URI
    value: https://github.com/BCDevOps/platform-services.git
  - name: GIT_REF
    value: master
  - name: PG_VERSION
    value: "10"
objects:
#Postgres ImageStream is created if it doesn't already exist
- apiVersion: image.openshift.io/v1
  kind: ImageStream
  metadata:
    name: postgres
  spec:
    lookupPolicy:
      local: false
- apiVersion: v1
  kind: ImageStreamTag
  lookupPolicy:
    local: false
  metadata:
    name: postgres:${PG_VERSION}
  tag:
    annotations: null
    from:
      kind: DockerImage
      name: registry.hub.docker.com/library/postgres:${PG_VERSION}
    importPolicy:
      scheduled: true
    name: "${PG_VERSION}"
    referencePolicy:
      type: Source
- apiVersion: v1
  kind: ImageStream
  metadata:
    creationTimestamp: null
    name: ${NAME}
  spec:
    lookupPolicy:
      local: false
  status:
    dockerImageRepository: ""
- apiVersion: v1
  kind: BuildConfig
  metadata:
    creationTimestamp: null
    name: ${NAME}${SUFFIX}
  spec:
    nodeSelector: null
    output:
      to:
        kind: ImageStreamTag
        name: "${NAME}:${OUT_VERSION}"
    postCommit: {}
    resources: {}
    source:
      contextDir: apps/pgsql/patroni/docker
      git:
        ref: ${GIT_REF}
        uri: ${GIT_URI}
      type: Git
    strategy:
      dockerStrategy:
        from:
          kind: ImageStreamTag
          name: postgres:${PG_VERSION}
      type: Docker
    triggers:
    - type: ConfigChange
    - imageChange: {}
      type: ImageChange
  status:
    lastVersion: 0
</pre>
                </code>
                <h2 id="patroni-deployment">patroni-deployment.yaml</h2>
                <pre>
    <code>
      apiVersion: template.openshift.io/v1
kind: Template
metadata:
  annotations:
    description: |-
      Patroni Postgresql database cluster, with persistent storage.
    iconClass: icon-postgresql
    openshift.io/display-name: Patroni Postgresql (Persistent)
    openshift.io/long-description: This template deploys a patroni postgresql HA
      cluster with persistent storage.
    tags: postgresql
  name: patroni-pgsql-persistent
labels:
  app: ${NAME}${SUFFIX}
  phase: deploy
  app.kubernetes.io/instance: ${NAME}${SUFFIX}
  app.kubernetes.io/component: database
  app.kubernetes.io/name: patroni  
  app.kubernetes.io/managed-by: template
objects:
# It doesn't seem to be used/needed - remote it?
#- apiVersion: v1
#  kind: Service
#  metadata:
#    creationTimestamp: null
#    labels:
#      cluster-name: ${NAME}${SUFFIX}
#    name: ${NAME}${SUFFIX}
#  spec:
#    ports:
#    - name: 'postgresql'
#      port: 5432
#      protocol: TCP
#      targetPort: 5432
#    sessionAffinity: None
#    type: ClusterIP
#  status:
#    loadBalancer: {}
- apiVersion: v1
  kind: Service
  metadata:
    creationTimestamp: null
    labels:
      cluster-name: ${NAME}${SUFFIX}
    name: ${NAME}-master${SUFFIX}
  spec:
    ports:
    - port: 5432
#      name: 'postgresql'
      protocol: TCP
      targetPort: 5432
    selector:
      cluster-name: ${NAME}${SUFFIX}
      role: master
      app.kubernetes.io/name: patroni
    sessionAffinity: None
    type: ClusterIP
  status:
    loadBalancer: {}
#- apiVersion: v1
#  kind: Service
#  metadata:
#    creationTimestamp: null
#    labels:
#      cluster-name: ${NAME}${SUFFIX}
#    name: ${NAME}-replica${SUFFIX}
#  spec:
#    ports:
#    - port: 5432
##      name: 'postgresql'
#      protocol: TCP
#      targetPort: 5432
#    selector:
#      cluster-name: ${NAME}${SUFFIX}
#      app.kubernetes.io/name: patroni
#      role: replica
#    sessionAffinity: None
#    type: ClusterIP
#  status:
#    loadBalancer: {}
# - apiVersion: v1
#   kind: ConfigMap
#   metadata:
#     name: ${NAME}${SUFFIX}-config
# - apiVersion: v1
#   kind: ConfigMap
#   metadata:
#     name: ${NAME}${SUFFIX}-leader
- apiVersion: apps/v1
  kind: StatefulSet
  metadata:
    creationTimestamp: null
    generation: 3
    labels:
      cluster-name: ${NAME}${SUFFIX}
    name: ${NAME}${SUFFIX}
  spec:
    podManagementPolicy: OrderedReady
    replicas: ${{REPLICAS}}
    revisionHistoryLimit: 10
    selector:
      matchLabels:
        statefulset: ${NAME}${SUFFIX}
    serviceName: ${NAME}${SUFFIX}
    template:
      metadata:
        creationTimestamp: null
        labels:
          statefulset: ${NAME}${SUFFIX}
          cluster-name: ${NAME}${SUFFIX}
          app.kubernetes.io/name: patroni
      spec:
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                - key: statefulset
                  operator: In
                  values: 
                  - ${NAME}${SUFFIX}
              topologyKey: "kubernetes.io/hostname"
        containers:
        - env:
          #TODO: Remove POD_IP in favor of PATRONI_KUBERNETES_POD_IP
          - name: POD_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.podIP
#          - name: PATRONI_KUBERNETES_USE_ENDPOINTS
#            value: 'true'
#          - name: PATRONI_KUBERNETES_POD_IP
#            valueFrom:
#              fieldRef:
#                apiVersion: v1
#                fieldPath: status.podIP
#          - name: PATRONI_KUBERNETES_PORTS
#            value: '{[{"name": "postgresql", "port": 5432}]}'
          - name: PATRONI_KUBERNETES_NAMESPACE
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.namespace
          - name: PATRONI_KUBERNETES_LABELS
            value: '{"cluster-name": "${NAME}${SUFFIX}", "app.kubernetes.io/name": "patroni"}'
          - name: PATRONI_SUPERUSER_USERNAME
            valueFrom:
              secretKeyRef:
                key: superuser-username
                name: ${NAME}${SUFFIX}
          - name: PATRONI_SUPERUSER_PASSWORD
            valueFrom:
              secretKeyRef:
                key: superuser-password
                name: ${NAME}${SUFFIX}
          - name: PATRONI_REPLICATION_USERNAME
            valueFrom:
              secretKeyRef:
                key: replication-username
                name: ${NAME}${SUFFIX}
          - name: PATRONI_REPLICATION_PASSWORD
            valueFrom:
              secretKeyRef:
                key: replication-password
                name: ${NAME}${SUFFIX}
          - name: APP_USER
            valueFrom:
              secretKeyRef:
                key: app-db-username
                name: ${NAME}${SUFFIX}
          - name: APP_PASSWORD
            valueFrom:
              secretKeyRef:
                key: app-db-password
                name: ${NAME}${SUFFIX}
          - name: APP_DATABASE
            valueFrom:
              secretKeyRef:
                key: app-db-name
                name: ${NAME}${SUFFIX}
          - name: PATRONI_SCOPE
            value: ${NAME}${SUFFIX}
          - name: PATRONI_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: PATRONI_LOG_LEVEL
            value: WARNING
          - name: PATRONI_POSTGRESQL_DATA_DIR
            value: /home/postgres/pgdata/pgroot/data
          - name: PATRONI_POSTGRESQL_PGPASS
            value: /tmp/pgpass
          - name: PATRONI_POSTGRESQL_LISTEN
            value: 0.0.0.0:5432
          - name: PATRONI_RESTAPI_LISTEN
            value: 0.0.0.0:8008
          image: ${IMAGE_REGISTRY}/${IMAGE_STREAM_NAMESPACE}/${IMAGE_STREAM_TAG}
          # Because we are using image reference to a tag, we need to always pull the image otherwise
          #   we end up with outdated/out-of-sync image depending on the node where it is running
          imagePullPolicy: Always
          name: postgresql
          ports:
          - containerPort: 8008
            protocol: TCP
          - containerPort: 5432
            protocol: TCP
          resources:
            requests:
              cpu: ${CPU_REQUEST}
              memory: ${MEMORY_REQUEST}
            limits:
              cpu: ${CPU_LIMIT}
              memory: ${MEMORY_LIMIT}
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          readinessProbe:
            initialDelaySeconds: 5
            timeoutSeconds: 5
            failureThreshold: 4
            exec:
              command:
                - /usr/share/scripts/patroni/health_check.sh
          volumeMounts:
          - mountPath: /home/postgres/pgdata
            name: postgresql
        dnsPolicy: ClusterFirst
        restartPolicy: Always
        schedulerName: default-scheduler
        securityContext: {}
        serviceAccountName: ${NAME}${SUFFIX}
        terminationGracePeriodSeconds: 0
    updateStrategy:
      type: RollingUpdate
    volumeClaimTemplates:
    - metadata:
        annotations:
          volume.beta.kubernetes.io/storage-class: ${STORAGE_CLASS}
        labels:
          app: ${NAME}${SUFFIX}
        name: postgresql
      spec:
        storageClassName: ${STORAGE_CLASS}
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: ${PVC_SIZE}
# It doesn't seem to be used/needed - remote it?
#- apiVersion: v1
#  kind: Endpoints
#  metadata:
#    labels:
#      app: ${NAME}${SUFFIX}
#      cluster-name: ${NAME}${SUFFIX}
#    name: ${NAME}${SUFFIX}
#  subsets: []
parameters:
- description: The name of the application for labelling all artifacts.
  displayName: Application Name
  name: NAME
  value: patroni
- name: SUFFIX
  description: A suffix appended to all artifact's name (NAME)
- name: REPLICAS
  displayName: REPLICAS
  description: The number of statefulSet replicas to use.
  value: '3'
- description: Starting amount of CPU the container can use.
  displayName: CPU REQUEST
  name: CPU_REQUEST
  value: '250m'
- description: Maximum amount of CPU the container can use.
  displayName: CPU Limit
  name: CPU_LIMIT
  value: '1'
- description: Starting amount of memory the container can use.
  displayName: Memory Request
  name: MEMORY_REQUEST
  value: 512Mi
- description: Maximum amount of memory the container can use.
  displayName: Memory Limit
  name: MEMORY_LIMIT
  value: 512Mi
- description: The OpenShift Namespace where the patroni and postgresql ImageStream
    resides.
  displayName: ImageStream Namespace
  name: IMAGE_STREAM_NAMESPACE
  value: "bcgov"
- name: IMAGE_STREAM_TAG
  description: Patroni ImageTag
  value: patroni:v11-stable
- description: The size of the persistent volume to create.
  displayName: Persistent Volume Size
  name: PVC_SIZE
  value: 1Gi
- name: STORAGE_CLASS
  value: netapp-block-standard
- name: IMAGE_REGISTRY
  #ocp3#docker-registry.default.svc:5000
  value: image-registry.openshift-image-registry.svc:5000
    </code>
  </pre>
                <h2 id="patroni-deployment-prereq">patroni-deployment-prereq.yaml</h2>
                <pre>
    <code>
      apiVersion: template.openshift.io/v1
kind: Template
metadata:
  annotations:
    description: |-
      Patroni Postgresql database cluster (pre-requisites)
    iconClass: icon-postgresql
    openshift.io/display-name: Patroni Postgresql pre-requisites
    openshift.io/long-description: This template deploys patroni pre-requisites for an HA DB (secret, service account, role)
    tags: postgresql
  name: patroni-pgsql-pre-requisite
labels:
  app.kubernetes.io/component: database
  app.kubernetes.io/name: patroni
  app.kubernetes.io/managed-by: template
objects:
- apiVersion: v1
  kind: Secret
  metadata:
    labels:
      app: ${NAME}${SUFFIX}
      cluster-name: ${NAME}${SUFFIX}
    annotations:
      as-copy-of: "template.${NAME}-patroni"
    name: ${NAME}${SUFFIX}
  stringData:
    replication-username: ${PATRONI_REPLICATION_USERNAME}
    replication-password: ${PATRONI_REPLICATION_PASSWORD}
    superuser-username: ${PATRONI_SUPERUSER_USERNAME}
    superuser-password: ${PATRONI_SUPERUSER_PASSWORD}
    app-db-name: ${APP_DB_NAME}
    app-db-username: ${APP_DB_USERNAME}
    app-db-password: ${APP_DB_PASSWORD}
- apiVersion: v1
  kind: ServiceAccount
  metadata:
    labels:
      cluster-name: ${NAME}${SUFFIX}
    name: ${NAME}${SUFFIX}
- apiVersion: rbac.authorization.k8s.io/v1
  kind: Role
  metadata:
    labels:
      cluster-name: ${NAME}${SUFFIX}
    name: ${NAME}${SUFFIX}
  rules:
  - apiGroups:
    - ""
    resources:
    - services
    verbs:
    - create
    - get
    - list
    - patch
    - update
    - watch
    - delete
  - apiGroups:
    - ""
    resources:
    - configmaps
    verbs:
    - create
    - get
    - list
    - patch
    - update
    - watch
    - delete
  - apiGroups:
    - ""
    resources:
    - endpoints
    verbs:
    - get
    - patch
    - update
    - create
    - list
    - watch
    - delete
  - apiGroups:
    - ""
    resources:
    - pods
    verbs:
    - get
    - list
    - patch
    - update
    - watch
- apiVersion: rbac.authorization.k8s.io/v1
  kind: RoleBinding
  metadata:
    labels:
      cluster-name: ${NAME}${SUFFIX}
    name: ${NAME}${SUFFIX}
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: Role
    name: ${NAME}${SUFFIX}
  subjects:
  - kind: ServiceAccount
    name: ${NAME}${SUFFIX}
parameters:
- description: The name of the application for labelling all artifacts.
  displayName: Application Name
  name: NAME
  value: patroni
- name: SUFFIX
- description: Username of the superuser account for initialization.
  displayName: Superuser Username
  name: PATRONI_SUPERUSER_USERNAME
  value: postgres
#  generate: expression
#  from: super-[a-zA-Z0-9]{6}
- description: Password of the superuser account for initialization.
  displayName: Superuser Passsword
  name: PATRONI_SUPERUSER_PASSWORD
  generate: expression
  from: '[a-zA-Z0-9]{32}'
- description: Username of the replication account for initialization.
  displayName: Replication Username
  name: PATRONI_REPLICATION_USERNAME
  value: replication
#  generate: expression
#  from: rep-[a-zA-Z0-9]{6}
- description: Password of the replication account for initialization.
  displayName: Repication Passsword
  name: PATRONI_REPLICATION_PASSWORD
  generate: expression
  from: '[a-zA-Z0-9]{32}'
- name: APP_DB_USERNAME
  value: app
- name: APP_DB_NAME
  value: app
- name: APP_DB_PASSWORD
  generate: expression
  from: '[a-zA-Z0-9]{32}'
    </code>
  </pre>

                <br>
                <hr>
                <table>
                  <tr>
                    <th>title</th>
                    <th>description</th>
                    <th>tags</th>

                  </tr>
                  <tr>
                    <td>Patroni Cluster Setup in Openshift 4</td>
                    <td>This resource provides instructions for setting up a Patroni cluster in the Openshift 4
                      environment.</td>
                    <td>
                      <table>
                        <tr>
                          <td>openshift</td>
                          <td>patroni</td>
                          <td>postgresql</td>
                          <td>ha</td>
                          <td>database</td>
                          <td>
                            high availability cluster</td>
                        </tr>
                      </table>
                    </td>
                  </tr>
                </table>
                <hr>
                <h2 id="patroni-cluster-setup-in-openshift-4">Patroni Cluster Setup in Openshift 4</h2>
                <h3 id="source-credit">Source &amp; Credit</h3>
                <p>Contributed to and copied from <a
                    href="https://github.com/zalando/patroni">https://github.com/zalando/patroni</a></p>
                <h2 id="additional-information">Additional Information</h2>
                <p>This documentation contains primarily examples on how to get patroni running on our Openshift
                  cluster. For full documentation on Patroni, please see <a
                    href="https://patroni.readthedocs.io/en/latest/">https://patroni.readthedocs.io/en/latest/</a></p>
                <h2 id="patroni-openshift-configuration">Patroni OpenShift Configuration</h2>
                <p>Patroni can be run in OpenShift. Based on the kubernetes configuration, the Dockerfile and Entrypoint
                  has been modified to support the dynamic UID/GID configuration that is applied in OpenShift. This can
                  be run under the standard <code>restricted</code> SCC.</p>
                <h2 id="examples">Examples</h2>
                <h3 id="create-test-project">Create test project</h3>
                <pre><code>oc<span class="hljs-built_in"> new-project </span>patroni-test
</code></pre>
                <h3 id="build-the-image">Build the image</h3>
                <blockquote>
                  <p>Note: Update the references when merged upstream.</p>
                  <p>Note: If deploying as a template for multiple users, the following commands should be performed in
                    a shared namespace like <code>openshift</code>.</p>
                </blockquote>
                <pre><code class="lang-bash">oc process -f openshift/build.yaml \
 -p "GIT_URI=$(git config <span class="hljs-comment">--get remote.origin.url)" \</span>
 -p "GIT_REF=$(git rev-parse <span class="hljs-comment">--abbrev-ref HEAD)" \</span>
 -p SUFFIX=-pg11 \
 -p OUT_VERSION=v11-latest \
 -p PG_VERSION=11 | oc <span class="hljs-keyword">create</span> -f -

# <span class="hljs-keyword">Trigger</span> a <span class="hljs-keyword">build</span>
oc <span class="hljs-keyword">start</span>-<span class="hljs-keyword">build</span> patroni-pg11

#HINT: avoid unnecessary commits <span class="hljs-keyword">and</span> <span class="hljs-keyword">build</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">current</span> git <span class="hljs-keyword">clone</span>/checkout directory.
#oc <span class="hljs-keyword">start</span>-<span class="hljs-keyword">build</span> patroni<span class="hljs-number">-001</span> <span class="hljs-string">"--from-dir=$(git rev-parse --show-toplevel)"</span> <span class="hljs-comment">--wait</span>

oc tag patroni:v11-latest patroni:v11-stable
</code></pre>
                <p>Simply change the OUT_VERSION and the PG_VERSION if you would like a build with a different postgres
                  base (also created a separate buildconfig in this example for parallel builds):</p>
                <pre><code class="lang-bash">oc process -f openshift/build.yaml \
 -<span class="ruby">p <span class="hljs-string">"GIT_URI=$(git config --get remote.origin.url)"</span> \
</span> -<span class="ruby">p <span class="hljs-string">"GIT_REF=$(git rev-parse --abbrev-ref HEAD)"</span> \
</span> -<span class="ruby">p SUFFIX=-pg1<span class="hljs-number">0</span> \
</span> -<span class="ruby">p OUT_VERSION=v1<span class="hljs-number">0</span>-latest \
</span> -<span class="ruby">p PG_VERSION=<span class="hljs-number">10</span> <span class="hljs-params">| oc create -f -</span></span>
</code></pre>
                <blockquote>
                  <p>Note: <code>oc create</code> is used for the build explicitly to avoid overwriting/updating the
                    postgres imageStream object. Additional postgres imageStream Tags are added as long as the
                    PG_VERSION tag does not exist in the imageStream.</p>
                </blockquote>
                <h3 id="deploy-the-statefulset">Deploy the statefulSet</h3>
                <blockquote>
                  <p>Note: <code>oc create</code> is used for the pre-requisites to avoid re-generating secrets
                    accidentally</p>
                </blockquote>
                <pre><code class="lang-bash">oc process -f openshift/deployment-prereq.yaml \
 -p NAME=patroni \
 -p SUFFIX=-001 | oc <span class="hljs-keyword">create</span> -f -

oc process -f openshift/deployment.yaml \
 -p <span class="hljs-keyword">NAME</span>=patroni \
 -p <span class="hljs-string">"IMAGE_STREAM_NAMESPACE=$(oc project -q)"</span> \
 -p <span class="hljs-string">"IMAGE_STREAM_TAG=patroni:v11-latest"</span> \
 -p REPLICAS=<span class="hljs-number">3</span> \
 -p SUFFIX=<span class="hljs-number">-001</span> | oc <span class="hljs-keyword">apply</span> -f -

# HINT: Internal registry <span class="hljs-keyword">changed</span> <span class="hljs-keyword">between</span> OCP3 <span class="hljs-keyword">and</span> OCP4.  <span class="hljs-keyword">Current</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">for</span> OCP4.  Simply <span class="hljs-keyword">add</span> the <span class="hljs-keyword">following</span> <span class="hljs-keyword">option</span> <span class="hljs-keyword">to</span> the deployment.yaml <span class="hljs-keyword">to</span> deploy <span class="hljs-keyword">on</span> OCP <span class="hljs-number">3.11</span>
# -p IMAGE_REGISTRY=docker-registry.default.svc:<span class="hljs-number">5000</span>
</code></pre>
                <p>Additional helpful operational cli samples:</p>
                <pre><code class="lang-bash">oc scale StatefulSet/patroni<span class="hljs-number">-001</span> --replicas=<span class="hljs-number">1</span> --timeout=<span class="hljs-number">1</span>m
oc scale StatefulSet/patroni<span class="hljs-number">-001</span> --replicas=<span class="hljs-number">0</span> --timeout=<span class="hljs-number">1</span>m &amp;&amp; oc delete configmap/patroni<span class="hljs-number">-001</span>-config

oc delete configmap,statefulset,service,endpoints -l cluster-name=patroni<span class="hljs-number">-001</span>

# Clean everthing
oc delete all -l cluster-name=patroni<span class="hljs-number">-001</span>
oc delete pvc,secret,configmap,rolebinding,role -l cluster-name=patroni<span class="hljs-number">-001</span>
</code></pre>
                <h3 id="template-options">Template Options</h3>
                <p>Two configuration templates exist in <a href="templates">templates</a> directory:</p>
                <ul>
                  <li>Patroni Ephemeral</li>
                  <li>Patroni Persistent</li>
                </ul>
                <p>The only difference is whether or not the statefulset requests persistent storage.</p>
                <h3 id="create-the-template">Create the Template</h3>
                <p>Install the template into the <code>openshift</code> namespace if this should be shared across
                  projects:</p>
                <pre><code class="lang-bash">oc create -f templates/template_patroni_ephemeral<span class="hljs-selector-class">.yml</span> -n openshift
oc create -f templates/template_patroni_persistent<span class="hljs-selector-class">.yml</span> -n openshift
</code></pre>
                <p>Then, from your own project:</p>
                <pre><code class="lang-bash">oc<span class="hljs-built_in"> new-app </span>patroni-pgsql-ephemeral
</code></pre>
                <p>Once the pods are running, two configmaps should be available:</p>
                <pre><code class="lang-bash">$ oc get configmap
NAME                DATA      AGE
patroniocp-config   <span class="hljs-number">0</span>         <span class="hljs-number">1</span>m
patroniocp-leader   <span class="hljs-number">0</span>         <span class="hljs-number">1</span>m
</code></pre>
                <h3 id="development">Development</h3>
                <p>Install minishift and use the scripts in <code>test/*</code> to build/deploy/test</p>
                <ul>
                  <li><code>test/e2e.sh</code>: runs all tests</li>
                  <li><code>test/build.sh</code>: Test Build</li>
                  <li><code>test/deploy.sh</code>: Test Deployment<ul>
                      <li><code>test/patroni.sh</code>: Test Patroni</li>
                      <li><code>test/psql.sh</code>: Test PostgreSQL</li>
                    </ul>
                  </li>
                </ul>
                <h3 id="troubleshooting">Troubleshooting</h3>
                <p>Find tips for troubleshooting problems with a Patroni cluster <a
                    href="https://github.com/bcgov/nr-get-token/wiki/Patroni-Troubleshooting">here</a></p>
                <h3 id="todo">TODO</h3>
                <ul>
                  <li>[x] Need to add anti-affinity rules</li>
                  <li>[ ] Investigate using redhat postgres image as base image</li>
                </ul>
                <h3 id="references">References</h3>
                <ul>
                  <li><a
                      href="https://github.com/sclorg/postgresql-container/blob/generated/10/root/usr/bin/run-postgresql">https://github.com/sclorg/postgresql-container/blob/generated/10/root/usr/bin/run-postgresql</a>
                  </li>
                  <li><a
                      href="https://github.com/sclorg/postgresql-container/blob/generated/10/root/usr/share/container-scripts/postgresql/common.sh">https://github.com/sclorg/postgresql-container/blob/generated/10/root/usr/share/container-scripts/postgresql/common.sh</a>
                  </li>
                </ul>
                <h2 id="postgresql-deploy">postgresql-deploy</h2>
                <pre>
    <code>
      {
        "kind": "Template",
        "apiVersion": "v1",
        "metadata": {
          "annotations": {
            "description": "Deployment template for a postgresql server with persistent storage.",
            "tags": "${NAME}-${TAG_NAME}"
          },
          "name": "${NAME}-deploy"
        },
        "objects": [
          {
            "kind": "DeploymentConfig",
            "apiVersion": "v1",
            "metadata": {
              "name": "${NAME}-${TAG_NAME}",
              "generation": 1,
              "labels": {
                "app": "${NAME}-${TAG_NAME}",
                "app-group": "${APP_GROUP}",
                "template": "${NAME}-deploy"
              }
            },
            "spec": {
              "strategy": {
                "type": "Recreate",
                "recreateParams": {
                  "timeoutSeconds": 600
                },
                "resources": {},
                "activeDeadlineSeconds": 21600
              },
              "triggers": [
                {
                  "type": "ImageChange",
                  "imageChangeParams": {
                    "automatic": true,
                    "containerNames": ["${NAME}-${TAG_NAME}"],
                    "from": {
                      "kind": "ImageStreamTag",
                      "namespace": "openshift",
                      "name": "postgresql:10"
                    }
                  }
                },
                {
                  "type": "ConfigChange"
                }
              ],
              "replicas": 1,
              "test": false,
              "selector": {
                "name": "${NAME}-${TAG_NAME}"
              },
              "template": {
                "metadata": {
                  "labels": {
                    "name": "${NAME}-${TAG_NAME}"
                  }
                },
                "spec": {
                  "volumes": [
                    {
                      "name": "${NAME}-data",
                      "persistentVolumeClaim": {
                        "claimName": "${NAME}-${TAG_NAME}"
                      }
                    }
                  ],
                  "containers": [
                    {
                      "name": "${NAME}-${TAG_NAME}",
                      "image": " ",
                      "ports": [
                        {
                          "containerPort": 5432,
                          "protocol": "TCP"
                        }
                      ],
                      "env": [
                        {
                          "name": "POSTGRESQL_USER",
                          "valueFrom": {
                            "configMapKeyRef": {
                              "name": "${NAME}-${TAG_NAME}-config",
                              "key": "DATABASE_USER"
                            }
                          }
                        },
                        {
                          "name": "POSTGRESQL_PASSWORD",
                          "valueFrom": {
                            "secretKeyRef": {
                              "name": "${NAME}-${TAG_NAME}-secret",
                              "key": "DATABASE_PASSWORD"
                            }
                          }
                        },
                        {
                          "name": "POSTGRESQL_DATABASE",
                          "valueFrom": {
                            "configMapKeyRef": {
                              "name": "${NAME}-${TAG_NAME}-config",
                              "key": "DATABASE_NAME"
                            }
                          }
                        },
                        {
                          "name": "POSTGRESQL_ADMIN_DATABASE",
                          "valueFrom": {
                            "secretKeyRef": {
                              "name": "${NAME}-${TAG_NAME}-secret",
                              "key": "DATABASE_ADMIN_PASSWORD"
                            }
                          }
                        }
                      ],
                      "resources": {
                        "limits": {
                          "memory": "${MEMORY_LIMIT}"
                        }
                      },
                      "volumeMounts": [
                        {
                          "name": "${NAME}-data",
                          "mountPath": "/var/lib/pgsql/data"
                        }
                      ],
                      "livenessProbe": {
                        "tcpSocket": {
                          "port": 5432
                        },
                        "initialDelaySeconds": 30,
                        "timeoutSeconds": 1,
                        "periodSeconds": 10,
                        "successThreshold": 1,
                        "failureThreshold": 3
                      },
                      "readinessProbe": {
                        "exec": {
                          "command": [
                            "/bin/sh",
                            "-i",
                            "-c",
                            "psql -h 127.0.0.1 -U $POSTGRESQL_USER -q -d $POSTGRESQL_DATABASE -c 'SELECT 1'"
                          ]
                        },
                        "initialDelaySeconds": 5,
                        "timeoutSeconds": 1,
                        "periodSeconds": 10,
                        "successThreshold": 1,
                        "failureThreshold": 3
                      },
                      "terminationMessagePath": "/dev/termination-log",
                      "terminationMessagePolicy": "File",
                      "imagePullPolicy": "IfNotPresent",
                      "securityContext": {
                        "capabilities": {},
                        "privileged": false
                      }
                    }
                  ],
                  "restartPolicy": "Always",
                  "terminationGracePeriodSeconds": 30,
                  "dnsPolicy": "ClusterFirst",
                  "securityContext": {},
                  "schedulerName": "default-scheduler"
                }
              }
            }
          },
          {
            "kind": "PersistentVolumeClaim",
            "apiVersion": "v1",
            "metadata": {
              "name": "${NAME}-${TAG_NAME}",
              "labels": {
                "app": "${NAME}-${TAG_NAME}",
                "app-group": "${APP_GROUP}",
                "template": "${NAME}-deploy"
              }
            },
            "spec": {
              "storageClassName": "${PERSISTENT_VOLUME_CLASS}",
              "accessModes": ["ReadWriteOnce"],
              "resources": {
                "requests": {
                  "storage": "${PERSISTENT_VOLUME_SIZE}"
                }
              }
            }
          },
          {
            "kind": "ConfigMap",
            "apiVersion": "v1",
            "metadata": {
              "name": "${NAME}-${TAG_NAME}-config",
              "labels": {
                "app": "${NAME}-${TAG_NAME}",
                "app-group": "${APP_GROUP}",
                "template": "${NAME}-deploy"
              }
            },
            "data": {
              "DATABASE_HOST": "${DATABASE_HOST}-${TAG_NAME}",
              "DATABASE_NAME": "${DATABASE_NAME}",
              "DATABASE_USER": "${DATABASE_USER}",
              "DATABASE_PORT": "${DATABASE_PORT}"
            }
          },
          {
            "kind": "Secret",
            "apiVersion": "v1",
            "metadata": {
              "name": "${NAME}-${TAG_NAME}-secret",
              "labels": {
                "app": "${NAME}-${TAG_NAME}",
                "app-group": "${APP_GROUP}",
                "template": "${NAME}-deploy"
              }
            },
            "stringData": {
              "DATABASE_PASSWORD": "${POSTGRESQL_PASSWORD}",
              "DATABASE_ADMIN_PASSWORD": "${POSTGRESQL_ADMIN_PASSWORD}",
              "DATABASE_TEST_PASSWORD": "${POSTGRESQL_TEST_PASSWORD}"
            },
            "type": "Opaque"
          },
          {
            "kind": "Service",
            "apiVersion": "v1",
            "metadata": {
              "name": "${NAME}-${TAG_NAME}",
              "labels": {
                "app": "${NAME}-${TAG_NAME}",
                "app-group": "${APP_GROUP}",
                "template": "${NAME}-deploy"
              },
              "annotations": {
                "template.openshift.io/expose-uri": "postgres://{.spec.clusterIP}:{.spec.ports[?(.name==\"postgresql\")].port}"
              }
            },
            "spec": {
              "ports": [
                {
                  "name": "${NAME}-${TAG_NAME}",
                  "protocol": "TCP",
                  "port": 5432,
                  "targetPort": 5432
                }
              ],
              "selector": {
                "name": "${NAME}-${TAG_NAME}"
              },
              "type": "ClusterIP",
              "sessionAffinity": "None"
            }
          }
        ],
        "parameters": [
          {
            "name": "NAME",
            "displayName": "Name",
            "description": "The name assigned to all of the OpenShift resources associated to the PostgreSQL instance.",
            "required": true,
            "value": "camunda-postgresql"
          },
          {
            "name": "APP_GROUP",
            "displayName": "App Group",
            "description": "The name assigned to all of the deployments in this project.",
            "required": true,
            "value": "formio"
          },
          {
            "name": "TAG_NAME",
            "displayName": "Environment TAG name",
            "description": "The TAG name for this environment, e.g., dev, test, prod",
            "required": true,
            "value": "dev"
          },
          {
            "name": "MEMORY_LIMIT",
            "displayName": "Memory Limit",
            "description": "Maximum amount of memory the container can use.",
            "required": true,
            "value": "512Mi"
          },
          {
            "name": "PERSISTENT_VOLUME_SIZE",
            "displayName": "Persistent Volume Size",
            "description": "The size of the persistent volume , e.g. 512Mi, 1Gi, 2Gi.",
            "required": true,
            "value": "1Gi"
          },
          {
            "name": "PERSISTENT_VOLUME_CLASS",
            "displayName": "Persistent Volume Class name",
            "description": "The class of the volume; gluster-file, gluster-block, gluster-file-db.",
            "required": false,
            "value": "netapp-file-standard"
          },
          {
            "name": "POSTGRESQL_PASSWORD",
            "displayName": "PostgreSQL Connection Password",
            "description": "Password for the PostgreSQL connection user.  Needs to be basee64 encoded/",
            "required": true,
            "generate": "expression",
            "from": "[a-zA-Z0-9]{16}"
          },
          {
            "name": "POSTGRESQL_ADMIN_PASSWORD",
            "displayName": "PostgreSQL Connection Admin Password",
            "description": "Password for the PostgreSQL connection user.  Needs to be basee64 encoded/",
            "required": true,
            "generate": "expression",
            "from": "[a-zA-Z0-9]{16}"
          },
          {
            "name": "POSTGRESQL_TEST_PASSWORD",
            "displayName": "PostgreSQL Connection test Password",
            "description": "Password for the PostgreSQL connection user.  Needs to be basee64 encoded/",
            "required": true,
            "generate": "expression",
            "from": "[a-zA-Z0-9]{16}"
          },
          {
            "name": "DATABASE_NAME",
            "displayName": "Database Name",
            "description": "A valid database name used by the service.",
            "required": true,
            "value": "postgres"
          },
          {
            "name": "DATABASE_USER",
            "displayName": "Database User",
            "description": "A valid database user used by the service.",
            "required": true,
            "value": "postgres"
          },
          {
            "name": "DATABASE_HOST",
            "displayName": "Database host name",
            "description": "A valid database host name used by the service.",
            "required": true,
            "value": "postgresql"
          },
          {
            "name": "DATABASE_PORT",
            "displayName": "Database host port",
            "description": "A valid database host port used by the service.",
            "required": true,
            "value": "5432"
          }
        ]
      }
    </code>
  </pre>
                <h2 id="mongo-ha.yaml">mongo-ha.yaml</h2>
                <pre>
    <code>
     
      ---
kind: Template
apiVersion: v1
metadata:
  name: forms-flow-db
  labels:
    app: forms-flow-db
  annotations:
    description: "MongoDB database running as replicate set"
    tags: "mongodb,replication"
parameters:
  - name: MEMORY_REQUEST
    description: Amount of Memory to Request.
    displayName: Memory Request
    required: true
  - name: MEMORY_LIMIT
    description: Amount of Memory to Limit.
    displayName: Memory Limit
    required: true
  - name: CPU_REQUEST
    description: Amount of CPU to Request.
    displayName: Memory Request
    required: true
  - name: CPU_LIMIT
    description: Amount of CPU to Limit.
    displayName: Memory Limit
    required: true
  - name: MONGODB_SERVICE_NAME
    description: Name of the MongoDB Service
    displayName: MongoDB Service Name
    value: "hamongo"
    required: true
  - name: MONGODB_REPLICAS
    description: Number of MongoDB replica pods
    displayName: MongoDB Replicas
    value: "3"
    required: true
  - name: MONGODB_PASSWORD
    displayName: "MongoDB Connection Password"
    description: "Password for the MongoDB connection user."
    generate: expression
    from: "[a-zA-Z0-9]{16}"
    required: true
  - name: MONGODB_ADMIN_PASSWORD
    displayName: "MongoDB Admin Password"
    description: "Password for the database admin user."
    generate: expression
    from: "[a-zA-Z0-9]{16}"
    required: true
  - name: MONGODB_SECRET_NAME
    displayName: MongoDB Secret.
    description: Name of the Secret containing MongoDB Assets
    value: "mongodb-creds"
    required: true
  - name: MONGODB_USER
    displayName: "MongoDB Connection Username"
    description: "Username for MongoDB user that will be used for accessing the database."
    generate: expression
    from: "[a-zA-Z0-9]{5}"
    required: true
  - name: MONGODB_REPLICA_NAME
    displayName: "Replica Set Name"
    description: "The name of the replica set."
    value: "rs0"
    required: true
  - name: MONGODB_KEYFILE_VALUE
    displayName: "Keyfile Content"
    description: "The value of the MongoDB keyfile (https://docs.mongodb.com/manual/core/security-internal-authentication/#internal-auth-keyfile)."
    generate: expression
    from: "[a-zA-Z0-9]{255}"
    required: true
  - name: MONGODB_IMAGE
    displayName: "MongoDB Docker Image"
    description: "A reference to a supported MongoDB Docker image."
    value: registry.redhat.io/rhscl/mongodb-36-rhel7
    required: true
  - name: MONGODB_IMAGE_TAG
    description: Name of the MongoDB tag that should be used
    displayName: MongoDB Tag
    value: "1"
    required: true
  - name: VOLUME_CAPACITY
    displayName: "Volume Capacity for MongoDB"
    description: "Volume space available for data, e.g. 512Mi, 2Gi."
    required: true
  - name: SC_MONGO
    description: The Storage Class for the MongoDB
    displayName: Storage Class for MongoDB
    required: true
  - name: MONGODB_DATABASE
    displayName: "MongoDB Database Name"
    description: "Name of the MongoDB database accessed."
    value: forms-flow-db
    required: true

objects:
  - kind: Secret
    apiVersion: v1
    metadata:
      name: ${MONGODB_SECRET_NAME}
      labels:
        app: formio-chat-mongodb
    stringData:
      database: ${MONGODB_DATABASE}
      username: "${MONGODB_USER}"
      password: "${MONGODB_PASSWORD}"
      admin-username: "admin"
      admin-password: "${MONGODB_ADMIN_PASSWORD}"
      mongo-url: "mongodb://${MONGODB_USER}:${MONGODB_PASSWORD}@${MONGODB_SERVICE_NAME}:27017/${MONGODB_DATABASE}?replicaSet=${MONGODB_REPLICA_NAME}"
      mongo-oplog-url: "mongodb://admin:${MONGODB_ADMIN_PASSWORD}@${MONGODB_SERVICE_NAME}:27017/local?authSource=admin&replicaSet=${MONGODB_REPLICA_NAME}"
  - kind: Service
    apiVersion: v1
    metadata:
      name: "${MONGODB_SERVICE_NAME}"
      labels:
        app: forms-flow-db
    spec:
      ports:
        - name: mongodb
          port: 27017
      selector:
        statefulset: "${MONGODB_SERVICE_NAME}"
  - kind: Service
    apiVersion: v1
    metadata:
      name: "${MONGODB_SERVICE_NAME}-internal"
      labels:
        app: forms-flow-db
      annotations:
        service.alpha.kubernetes.io/tolerate-unready-endpoints: "true"
    spec:
      clusterIP: None
      ports:
        - name: mongodb
          port: 27017
      selector:
        statefulset: "${MONGODB_SERVICE_NAME}"
  - kind: StatefulSet
    apiVersion: apps/v1
    metadata:
      name: "${MONGODB_SERVICE_NAME}"
      labels:
        app: forms-flow-db
    spec:
      selector:
        matchLabels:
          statefulset: ${MONGODB_SERVICE_NAME}
      serviceName: "${MONGODB_SERVICE_NAME}-internal"
      replicas: ${{MONGODB_REPLICAS}}
      template:
        metadata:
          labels:
            app: forms-flow-db
            statefulset: ${MONGODB_SERVICE_NAME}
        spec:
          affinity:
            podAntiAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchExpressions:
                      - key: name
                        operator: In
                        values:
                          - ${MONGODB_SERVICE_NAME}
                  topologyKey: "kubernetes.io/hostname"
          containers:
            - name: mongo-container
              image: "${MONGODB_IMAGE}:${MONGODB_IMAGE_TAG}"
              ports:
                - containerPort: 27017
              args:
                - "run-mongod-replication"
              volumeMounts:
                - name: mongo-data
                  mountPath: "/var/lib/mongodb/data"
              env:
                - name: MONGODB_USER
                  valueFrom:
                    secretKeyRef:
                      key: username
                      name: "${MONGODB_SECRET_NAME}"
                - name: MONGODB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      key: password
                      name: "${MONGODB_SECRET_NAME}"
                - name: MONGODB_DATABASE
                  valueFrom:
                    secretKeyRef:
                      key: database
                      name: "${MONGODB_SECRET_NAME}"
                - name: MONGODB_ADMIN_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      key: admin-password
                      name: "${MONGODB_SECRET_NAME}"
                - name: MONGO_OPLOG_URL
                  valueFrom:
                    secretKeyRef:
                      key: mongo-oplog-url
                      name: "${MONGODB_SECRET_NAME}"
                - name: MONGODB_REPLICA_NAME
                  value: "${MONGODB_REPLICA_NAME}"
                - name: MONGODB_KEYFILE_VALUE
                  value: "${MONGODB_KEYFILE_VALUE}"
                - name: MONGODB_SERVICE_NAME
                  value: "${MONGODB_SERVICE_NAME}-internal"
              resources:
                limits:
                  memory: "${MEMORY_LIMIT}"
                  cpu: "${CPU_LIMIT}"
                requests:
                  memory: "${MEMORY_REQUEST}"
                  cpu: "${CPU_REQUEST}"
              exec:
                command:
                  - /bin/sh
                  - '-i'
                  - '-c'
                  - >-
                    mongo 127.0.0.1:27017/$MONGODB_DATABASE -u $MONGODB_USER -p
                    $MONGODB_PASSWORD --eval="quit()"
      volumeClaimTemplates:
        - metadata:
            name: mongo-data
            labels:
              name: "${MONGODB_SERVICE_NAME}"
              app: forms-flow-db
          spec:
            accessModes: [ ReadWriteOnce ]
            storageClassName: "${SC_MONGO}"
            resources:
              requests:
                storage: "${VOLUME_CAPACITY}"
    </code>
  </pre>
                <h2 id="mongodb-nonha.yaml">mongodb-nonha.yaml</h2>
                <pre>
    <code>
      ---
      apiVersion: v1
      kind: Template
      labels:
        app: "${APP_NAME}-${INSTANCE}"
        name: "${NAME}-${INSTANCE}"
        template: "${NAME}-${INSTANCE}-template"
      metadata:
        annotations:
          description: Deployment template for a mongodb server with persistent storage.
          tags: "${NAME}-${INSTANCE}"
      objects:
        - apiVersion: v1
          kind: DeploymentConfig
          metadata:
            name: "${NAME}-${INSTANCE}"
            generation: 1
          spec:
            strategy:
              type: Recreate
              recreateParams:
                timeoutSeconds: 600
              resources: {}
              activeDeadlineSeconds: 21600
            replicas: 1
            test: false
            selector:
              name: "${NAME}-${INSTANCE}"
            template:
              metadata:
                labels:
                  name: "${NAME}-${INSTANCE}"
                  app: "${APP_NAME}-${INSTANCE}"
                  role: "${ROLE}"
                  template: "${NAME}-${INSTANCE}"
              spec:
                volumes:
                  - name: "${NAME}-${INSTANCE}-data"
                    persistentVolumeClaim:
                      claimName: "${NAME}-${INSTANCE}"
                containers:
                  - name: "${NAME}-${INSTANCE}"
                    image: "${IMAGE_REGISTRY}/${IMAGE_NAMESPACE}/${IMAGE_NAME}"
                    ports:
                      - containerPort: 27017
                        protocol: TCP
                    env:
                      - name: MONGODB_USER
                        valueFrom:
                          secretKeyRef:
                            name: "${NAME}-${INSTANCE}-secret"
                            key: database-user
                      - name: MONGODB_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: "${NAME}-${INSTANCE}-secret"
                            key: database-password
                      - name: MONGODB_ADMIN_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: "${NAME}-${INSTANCE}-secret"
                            key: admin-password
                      - name: MONGODB_DATABASE
                        value: "${MONGODB_DATABASE}"
                    resources:
                      requests:
                        cpu: "${CPU_REQUEST}"
                        memory: "${MEMORY_REQUEST}"
                      limits:
                        cpu: "${CPU_LIMIT}"
                        memory: "${MEMORY_LIMIT}"
                    volumeMounts:
                      - name: "${NAME}-${INSTANCE}-data"
                        mountPath: "${MOUNT_PATH}"
                    livenessProbe:
                      tcpSocket:
                        port: 27017
                      initialDelaySeconds: 30
                      timeoutSeconds: 1
                      periodSeconds: 10
                      successThreshold: 1
                      failureThreshold: 3
                    readinessProbe:
                      exec:
                        command:
                          - "/bin/sh"
                          - "-i"
                          - "-c"
                          - timeout 1 mongo 127.0.0.1:27017/$MONGODB_DATABASE -u $MONGODB_USER -p $MONGODB_PASSWORD --eval='quit();'
                      initialDelaySeconds: 5
                      timeoutSeconds: 1
                      periodSeconds: 10
                      successThreshold: 1
                      failureThreshold: 3
                    terminationMessagePath: "/dev/termination-log"
                    terminationMessagePolicy: File
                    imagePullPolicy: IfNotPresent
                    securityContext:
                      capabilities: {}
                      privileged: false
                restartPolicy: Always
                terminationGracePeriodSeconds: 30
                dnsPolicy: ClusterFirst
                securityContext: {}
                schedulerName: default-scheduler
            triggers:
              - type: ConfigChange
        - apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: "${NAME}-${INSTANCE}"
          spec:
            storageClassName: "${PERSISTENT_VOLUME_CLASS}"
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: "${PERSISTENT_VOLUME_SIZE}"
        - apiVersion: v1
          kind: Service
          metadata:
            name: "${NAME}-${INSTANCE}"
          spec:
            ports:
              - name: mongodb
                protocol: TCP
                port: 27017
                targetPort: 27017
            selector:
              name: "${NAME}-${INSTANCE}"
            type: ClusterIP
            sessionAffinity: None
      parameters:
        - name: NAME
          displayName: Name
          description:
            The name assigned to all of the OpenShift resources associated to the server instance.
          required: true
          value: mongodb-formio-core
        - name: INSTANCE
          description: The name of this instance of the application
          displayName: Application Instance Name
          required: true
          value: dev
        - name: APP_NAME
          displayName: App Name
          description: Used to group components together in the OpenShift console.
          required: true
          value: formio
        - name: ROLE
          displayName: Role
          description:
            The role of this service within the application - used for Network Policies
          required: true
          value: db
        - name: IMAGE_REGISTRY
          description: The target docker registry
          displayName: Image Registry
          required: true
          value: registry.access.redhat.com
        - name: IMAGE_NAMESPACE
          description: The namespace where the mongodb image resides.
          displayName: Image Namespace
          required: true
          value: rhscl
        - name: IMAGE_NAME
          description: The target mongodb image
          displayName: Image Name
          required: true
          value: mongodb-36-rhel7
        - name: MONGODB_DATABASE
          displayName: MongoDB Database Name
          description: The name of the MongoDB database.
          required: true
          value: app
        - name: MOUNT_PATH
          displayName: Mount Path
          description: The path to mount the persistent volume.
          required: true
          value: "/var/lib/mongodb/data"
        - name: PERSISTENT_VOLUME_SIZE
          displayName: Persistent Volume Size
          description: The size of the persistent volume , e.g. 512Mi, 1Gi, 2Gi.
          required: true
          value: 1Gi
        - name: PERSISTENT_VOLUME_CLASS
          displayName: Persistent Volume Class name
          description:
            The class of the volume; gluster-file, gluster-block, gluster-file-db,netapp-file-standard
          required: false
          value: netapp-file-standard
        - name: CPU_REQUEST
          displayName: Resources CPU Request
          description: The resources CPU request (in cores) for this build.
          required: true
          value: 100m
        - name: CPU_LIMIT
          displayName: Resources CPU Limit
          description: The resources CPU limit (in cores) for this build.
          required: true
          value: 750m
        - name: MEMORY_REQUEST
          displayName: Resources Memory Request
          description: The resources Memory request (in Mi, Gi, etc) for this build.
          required: true
          value: 100Mi
        - name: MEMORY_LIMIT
          displayName: Resources Memory Limit
          description: The resources Memory limit (in Mi, Gi, etc) for this build.
          required: true
          value: 256Mi
    </code>
  </pre>
                <h2 id="formio_secrets.yaml">formio_secrets.yaml</h2>
                <pre>
  <code>
apiVersion: template.openshift.io/v1
kind: Template
metadata:
  name: ${NAME}
  labels:
    app: ${NAME}
    name: ${NAME}
objects:
  - apiVersion: v1
    kind: Secret
    metadata:
      name: ${NAME}
    stringData:
      db_password: "${PATRONI_PASSWORD}"
      db_username: "${PATRONI_USERNAME}"
      keycloak_clientid: "${keycloak_clientid}"
      keycloak_clientsecret: "${keycloak_clientsecret}"
      keycloak_realm: "${keycloak_realm}"
      camunda_formbuilder_pipeline_username: "${CAMUNDA_FORMBUILDER_PIPELINE_USERNAME}"
      formio_root_email: "${FORMIO_ROOT_EMAIL}"
      formio_root_password: "${FORMIO_ROOT_PASSWORD}"
      formio_jwt_secret: "${FORMIO_JWT_SECRET}"
      camunda_formbuilder_pipeline_password: "${CAMUNDA_FORMBUILDER_PIPELINE_PASSWORD}"
      camunda_analytics_jdbc_user: "${CAMUNDA_ANALYTICS_JDBC_USER}"
      camunda_analytics_jdbc_password: "${CAMUNDA_ANALYTICS_JDBC_PASSWORD}"
      BPM_API_BASE: "${BPM_API_BASE}"
      BPM_CLIENT_ID: '${FFA_BPM_KEYCLOAK_CLIENTID}'
      BPM_CLIENT_SECRET: '${FFA_BPM_KEYCLOAK_CLIENTSECRET}'
      BPM_TOKEN_API: ''
      JWT_OIDC_ALGORITHMS: RS256
      JWT_OIDC_AUDIENCE: forms-flow-web
      JWT_OIDC_CACHING_ENABLED: "True"
      JWT_OIDC_ISSUER: "${KEYCLOAK_URL}/auth/realms/${keycloak_realm}"
      JWT_OIDC_JWKS_CACHE_TIMEOUT: "300"
      JWT_OIDC_JWKS_URI: '${KEYCLOAK_URL}/auth/realms/${keycloak_realm}/protocol/openid-connect/certs'
      JWT_OIDC_WELL_KNOWN_CONFIG: "${KEYCLOAK_URL}/auth/realms/${keycloak_realm}/.well-known/openid-configuration"
      WEB_API_BASE_URL: "${WEB_API_BASE_URL}"
      DEBUG: formio:*
      MONGODB_URI: "${MONGODB_URI}"
      NODE_CONFIG: '{"mongo": "${MONGODB_URI}"}'
      DATABASE_URL: "postgresql://${PATRONI_USERNAME}:${PATRONI_PASSWORD}@${DATABASE_SERVICE_NAME}:${DATABASE_PORT}/${DATABASE_NAME}"


    type: Opaque

parameters:
  - name: NAME
    description: The name for all created objects.
    required: true
    value: forms-flow-ai
  - name: FORMIO_ROOT_EMAIL
    description: FORMIO_ROOT_EMAIL
    required: true
  - name: FORMIO_ROOT_PASSWORD
    description: FORMIO_ROOT_PASSWORD
    required: true
  - name: FORMIO_JWT_SECRET
    description: FORMIO_JWT_SECRET
    required: true
  - name: CAMUNDA_FORMBUILDER_PIPELINE_PASSWORD
    description: CAMUNDA_FORMBUILDER_PIPELINE_PASSWORD
    required: true
  - name: CAMUNDA_ANALYTICS_JDBC_USER
    description: CAMUNDA_ANALYTICS_JDBC_USER
    required: true
  - name: CAMUNDA_ANALYTICS_JDBC_PASSWORD
    description: CAMUNDA_ANALYTICS_JDBC_PASSWORD
    required: true
  - name: PATRONI_USERNAME
    displayName: PATRONI_USERNAME
    description:
      PATRONI_USERNAME
    required: true
  - name: PATRONI_PASSWORD
    displayName: PATRONI_PASSWORD
    description: PATRONI_PASSWORD
    required: true
  - name: keycloak_clientid
    displayName: keycloak_clientid
    description: keycloak_clientid
    required: true
  - name: keycloak_clientsecret
    displayName: keycloak_clientsecret
    description: keycloak_clientsecret
    required: true
  - name: KEYCLOAK_URL
    displayName: KEYCLOAK_URL
    description: KEYCLOAK_URL
    required: true
  - name: keycloak_realm
    displayName: keycloak_realm
    description: keycloak_realm
    required: true
  - name: CAMUNDA_FORMBUILDER_PIPELINE_USERNAME
    description: CAMUNDA_FORMBUILDER_PIPELINE_USERNAME
    required: true
  - name: FFA_BPM_KEYCLOAK_CLIENTSECRET
    description: FFA_BPM_KEYCLOAK_CLIENTSECRET
    required: true
  - name: FFA_BPM_KEYCLOAK_CLIENTID
    description: FFA_BPM_KEYCLOAK_CLIENTID
    required: true
  - name: WEB_API_BASE_URL
    description: WEB_API_BASE_URL
    required: true
  - name: DATABASE_SERVICE_NAME
    description: DATABASE_SERVICE_NAME
    required: true
  - name: DATABASE_PORT
    description: DATABASE_PORT
    required: true
  - name: DATABASE_NAME
    description: DATABASE_NAME
    required: true
  - name: MONGODB_URI
    description: MONGODB_URI
    required: true
  - name: BPM_API_BASE
    description: BPM_API_BASE
    required: true
  </code>
</pre>
                <h2 id="Dockerfile">Dockerfile</h2>
                <pre>
  <code>
# base image
FROM node:14.17.0-alpine as build-stage

# set working directory
WORKDIR /forms-flow-web/app

ARG NODE_ENV
ARG REACT_APP_CLIENT_ROLE
ARG REACT_APP_STAFF_REVIEWER_ROLE
ARG REACT_APP_STAFF_DESIGNER_ROLE
ARG REACT_APP_CLIENT_ID
ARG REACT_APP_STAFF_REVIEWER_ID
ARG REACT_APP_STAFF_DESIGNER_ID
ARG REACT_APP_USER_RESOURCE_FORM_ID
ARG REACT_APP_API_SERVER_URL
ARG REACT_APP_API_PROJECT_URL
ARG REACT_APP_KEYCLOAK_CLIENT
ARG REACT_APP_ANONYMOUS_ID
ARG REACT_APP_WEB_BASE_URL
ARG REACT_APP_CAMUNDA_API_URI
ARG REACT_APP_WEBSOCKET_ENCRYPT_KEY
ARG REACT_APP_KEYCLOAK_URL_REALM
ARG REACT_APP_KEYCLOAK_URL
ARG REACT_APP_APPLICATION_NAME
ARG REACT_APP_USER_ACCESS_PERMISSIONS
ARG REACT_APP_WEB_BASE_CUSTOM_URL
ARG REACT_APP_FORMIO_JWT_SECRET

ENV NODE_ENV ${NODE_ENV}
ENV REACT_APP_CLIENT_ROLE ${REACT_APP_CLIENT_ROLE}
ENV REACT_APP_STAFF_REVIEWER_ROLE ${REACT_APP_STAFF_REVIEWER_ROLE}
ENV REACT_APP_STAFF_DESIGNER_ROLE ${REACT_APP_STAFF_DESIGNER_ROLE}
ENV REACT_APP_CLIENT_ID ${REACT_APP_CLIENT_ID}
ENV REACT_APP_STAFF_REVIEWER_ID ${REACT_APP_STAFF_REVIEWER_ID}
ENV REACT_APP_STAFF_DESIGNER_ID ${REACT_APP_STAFF_DESIGNER_ID}
ENV REACT_APP_USER_RESOURCE_FORM_ID ${REACT_APP_USER_RESOURCE_FORM_ID}
ENV REACT_APP_API_SERVER_URL ${REACT_APP_API_SERVER_URL}
ENV REACT_APP_API_PROJECT_URL ${REACT_APP_API_PROJECT_URL}
ENV REACT_APP_KEYCLOAK_CLIENT ${REACT_APP_KEYCLOAK_CLIENT}
ENV REACT_APP_ANONYMOUS_ID ${REACT_APP_ANONYMOUS_ID}
ENV REACT_APP_WEB_BASE_URL ${REACT_APP_WEB_BASE_URL}
ENV REACT_APP_CAMUNDA_API_URI ${REACT_APP_CAMUNDA_API_URI}
ENV REACT_APP_WEBSOCKET_ENCRYPT_KEY ${REACT_APP_WEBSOCKET_ENCRYPT_KEY}
ENV REACT_APP_KEYCLOAK_URL_REALM ${REACT_APP_KEYCLOAK_URL_REALM}
ENV REACT_APP_KEYCLOAK_URL ${REACT_APP_KEYCLOAK_URL}
ENV REACT_APP_APPLICATION_NAME ${REACT_APP_APPLICATION_NAME}
ENV REACT_APP_USER_ACCESS_PERMISSIONS ${REACT_APP_USER_ACCESS_PERMISSIONS}
ENV REACT_APP_WEB_BASE_CUSTOM_URL ${REACT_APP_WEB_BASE_CUSTOM_URL}
ENV REACT_APP_FORMIO_JWT_SECRET ${REACT_APP_FORMIO_JWT_SECRET}
# add `/app/node_modules/.bin` to $PATH
ENV PATH /forms-flow-web/app/node_modules/.bin:$PATH

RUN apk update && apk upgrade && \
    apk add --no-cache bash git openssh

# install and cache app dependencies

COPY package-lock.json /forms-flow-web/app/package-lock.json
COPY package.json /forms-flow-web/app/package.json
COPY forms-flow-util/package.json /forms-flow-web/app/forms-flow-util/package.json
COPY forms-flow-util/package-lock.json /forms-flow-web/app/forms-flow-util/package-lock.json

RUN npm install --unsafe-perm --production
#RUN npm install react-scripts@3.0.1 -g --silent
COPY . /forms-flow-web/app/
RUN npm run build

FROM nginx:1.17 as production-stage
RUN mkdir /app
COPY --from=build-stage /forms-flow-web/app/build /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 8080:8080
CMD ["nginx", "-g", "daemon off;"]
  </code>
</pre>
                <h2 id="openshift_Dockerfile">Openshift_Dockerfile</h2>
                <pre>
  <code>
    # base image
FROM node:12.2.0-alpine as build-stage

# set working directory
WORKDIR /app

# add `/app/node_modules/.bin` to $PATH
ENV PATH /app/node_modules/.bin:$PATH

RUN apk update && apk upgrade && \
    apk add --no-cache bash git openssh

# install and cache app dependencies

COPY package-lock.json /app/package-lock.json
COPY package.json /app/package.json
COPY forms-flow-util/package.json /app/forms-flow-util/package.json
RUN npm install
#RUN npm install react-scripts@3.0.1 -g --silent
COPY . /app/
RUN npm run build

FROM nginx:1.17 as production-stage
RUN mkdir /app
COPY --from=build-stage /app/build /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 8080:8080
CMD ["nginx", "-g", "daemon off;"]
  </code>
</pre>
                <h2 id="openshift_custom_Dockerfile">Openshift_custom_Dockerfile</h2>
                <pre>
  <code>
    # Used as a reference for any custom logic to be done.
# if the application is built from a source repo other than aot , use the custom copying.
# steps : checkout the aot source code and use the copy logic.
# -----------------------------------------------------------
# base image
FROM docker-remote.artifacts.developer.gov.bc.ca/node:12.2.0-alpine as build-stage

# set working directory
WORKDIR /app

# add `/app/node_modules/.bin` to $PATH
ENV PATH /app/node_modules/.bin:$PATH

RUN apk update && apk upgrade && \
    apk add --no-cache bash git openssh

# Clone code
RUN git clone -b ${FORMIO_SOURCE_REPO_BRANCH} ${FORMIO_SOURCE_REPO_URL} /web/

RUN cp -rf /web/forms-flow-web/* /app/
RUN rm /app/public/formsflow.ai_icon.svg
COPY /public/formsflow.ai_icon.svg /app/public/

RUN npm install
RUN npm run build

FROM docker-remote.artifacts.developer.gov.bc.ca/nginx:1.17 as production-stage
RUN mkdir /app
COPY --from=build-stage /app/build /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 8080:8080
CMD ["nginx", "-g", "daemon off;"]
  </code>
</pre>


              </div>
            </section><br><br>
            <a href="architecture.html" class="previous">&laquo; Previous</a>
            <a href="features.html" class="next">Next &raquo;</a>

      </div>
      <!--//docs-code-block-->


      </header>


      </article>




      <!-- Javascript -->
      <script src="assets/plugins/popper.min.js"></script>
      <script src="assets/plugins/bootstrap/js/bootstrap.min.js"></script>


      <!-- Page Specific JS -->
      <script src="assets/plugins/smoothscroll.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/highlight.min.js"></script>
      <script src="assets/js/highlight-custom.js"></script>
      <script src="assets/plugins/simplelightbox/simple-lightbox.min.js"></script>
      <script src="assets/plugins/gumshoe/gumshoe.polyfills.min.js"></script>
      <script src="assets/js/docs.js"></script>

</body>

</html>